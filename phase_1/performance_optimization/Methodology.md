# 性能调优 - 性能调优方法论

性能调优就是用更少的资源提供更好的服务，成本利益最大化



## 常用名词解释

1. **QPS**：

   ​		**每秒查询率(Query Per Second)，是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。**在因特网上，作为域名系统服务器的机器的性能经常用每秒查询率(QPS)来衡量。对应fetches/sec，即每秒的响应请求数，也即是最大吞吐能力。

2. **TPS**：

   ​		**Transactions Per Second（每秒传输的事物处理个数），即服务器每秒处理的事务数。**TPS包括一条消息入和一条消息出，加上一次用户数据库访问。（业务TPS = CAPS × 每个呼叫平均TPS）

   ​		

3. **RT**：

   ​		**响应时间是指系统对请求作出响应的时间。**直观上看，这个指标与人对软件性能的主观感受是非常一致的，因为它完整地记录了整个计算机系统处理请求的时间。由于一个系统通常会提供许多功能，而不同功能的处理逻辑也千差万别，因而不同功能的响应时间也不尽相同，甚至同一功能在不同输入数据的情况下响应时间也不相同。所以，在讨论一个系统的响应时间时，人们通常是指该系统所有功能的平均时间或者所有功能的最大响应时间。当然，往往也需要对每个或每组功能讨论其平均响应时间和最大响应时间。 
   　　对于单机的没有并发操作的应用系统而言，人们普遍认为响应时间是一个合理且准确的性能指标。需要指出的是，响应时间的绝对值并不能直接反映软件的性能的高低，软件性能的高低实际上取决于用户对该响应时间的接受程度。对于一个游戏软件来说，响应时间小于100毫秒应该是不错的，响应时间在1秒左右可能属于勉强可以接受，如果响应时间达到3秒就完全难以接受了。而对于编译系统来说，完整编译一个较大规模软件的源代码可能需要几十分钟甚至更长时间，但这些响应时间对于用户来说都是可以接受的。

4. **并发量**：

   ​		**并发量是指系统可以同时承载的正常使用系统功能的用户的数量。**与吞吐量相比，并发量是一个更直观但也更笼统的性能指标。实际上，并发量是一个非常不准确的指标，因为用户不同的使用模式会导致不同用户在单位时间发出不同数量的请求。以网站系统为例，假设用户只有注册后才能使用，但注册用户并不是每时每刻都在使用该网站，因此具体一个时刻只有部分注册用户同时在线，在线用户就在浏览网站时会花很多时间阅读网站上的信息，因而具体一个时刻只有部分在线用户同时向系统发出请求。这样，对于网站系统我们会有三个关于用户数的统计数字：注册用户数、在线用户数和同时发请求用户数。由于注册用户可能长时间不登陆网站，使用注册用户数作为性能指标会造成很大的误差。而在线用户数和同时发请求用户数都可以作为性能指标。相比而言，以在线用户作为性能指标更直观些，而以同时发请求用户数作为性能指标更准确些。



​		**在针对单接口，TPS可以认为是等价于QPS的，如访问 ‘order.html’ 这个页面而言,是一个TPS。而访问 ‘order.html’ 页面可能请求了3此服务器（如调用了css、js、order接口），这实际就算产生了三个QPS** 

​		**所以，总结下就是，在针对单接口的时候TPS = QPS ,否则QPS就要看实际的请求次数了。**

​		如果吞吐量的“量”以“事务”为统计单位的话，结合时间维度，转化以后可以很容换算成**TPS**；如果吞吐量的“量”以“请求”为统计单位的话，结合时间维度，转化以后可以很容换算成**QPS**。

## 性能调优常规手段（方法/原则/规律）

1. **空间换时间**：

   ​		内存、缓存就是典型的空间换时间的例子。利用内存缓存从磁盘上取出的数据，CPU请求数据直接从内存中获取，从而获取比从磁盘读取数据更高的效率。

2. **时间换空间**：

   ​		当空间成为瓶颈时，切分数据分批次处理，用更少的空间完成任务处理。上传大附件时经常用这种方式。

3. **分而治之**：

   ​		把任务切分，分开执行，也方便并行执行来提高效率。

4. **异步处理**：

   ​		业务链路上有任务时间消耗较长，可以拆分业务，减少阻塞影响。常见的异步处理机制有MQ（消息队列），目前在互联网应用中大量使用。

5. **并行处理**：

   ​		多个进程或者线程同时处理业务，缩短业务处理时间，比如我们在银行办理业务时，如果排队人数较多时，银行会加开柜台。

6. **贴近用户**：

   ​		比如CDN技术，把用户请求的静态资源放在离用户更近的地方。

7. **可扩展化**：

   ​		业务模块化、服务化（同时无状态化）、良好的水平扩展能力。





## 性能分析的方法

性能分析是一个大课题，不同的架构、不同的应用场景、不同的程序语言分析的方法若有差异，抽象一下大致分为两类。

- **自底向上**：

  ​		通过监控硬件及操作系统的指标（CPU、内存、磁盘、网络等硬件资源的性能指标）来分析性能问题（配置、程序等问题）。因为用户请求最终是由计算机硬件设备来完成的，做事的是CPU。

- **自顶向下**：

  ​		通过生成负载来观察被测试的系统性能，比如响应时间、吞吐量；然后从请求的起点由外及里一层一层的分析，从而找到性能问题所在。
  


不管是自上而下还是自下而上，关键点就是生成负载、监控性能指标。好一点的方式是先用自顶向下的方式解决掉明显的性能问题，再结合自底向上的方式分析更深层次的问题。



## 性能调优的常规步骤

1. **检查RT**

   ​		模拟用户发起负载后，采用的自顶向下的方式首先分析RT（响应时间）。

2. **检查TPS**

   ​		吞吐量大时响应时间小，说明性能良好；吞吐量小时响应时间大，则说明性能较差。

3. **检查负载机资源**

   ​		检查CPU使用率，CPU负载（Load Average）确认是用户CPU占用高还是系统CPU占用高
   ​		前提：确认测试脚本没有性能问题，不会造成结果统计的不准确
   ​		检查内存使用情况，确认并发内存泄漏风险，不会造成结果统计的不准确

4. **判断负载机是否有性能问题**

   ​		排除负载机的性能问题，确保测试结果可参考

5. **检查Web服务器的资源消耗**

   ​		检查CPU使用率，确认用户CPU与系统CPU占用情况
   ​		检查内存使用情况，检查磁盘使用情况，检查占用的带宽
   ​		分析Web页面响应的时间组成，确认是什么请求影响了性能

6. **确认是否Web服务器瓶颈**

   ​		标判断是否是Web服务器硬件性能瓶颈

7. **检查中间件配置**	

   ​		确认是否是此配置问题

8. **检查应用服务器资源消耗**

   ​		关注CPU、内存、磁盘、IO，判断是否是应用服务器硬件性能瓶颈

9. **数据库服务器资源消耗分析**

   ​		CPU消耗，CPU负载，内存消耗，IO繁忙程度，数据库监控

10. **是否是DB性能问题**

    ​		由监控结果来判断是否是DB性能问题

11. **是否SQL问题**

    ​		1）定位最不合理的SQL占比 

    ​		2）索引是否正常引用 

    ​		3）检查共享SQL是否合理范围 

    ​		4）检查解析是否合理 

    ​		5）检查数据ER结构是否合理 

    ​		6）检查数据热点问题 

    ​		7）检查数据分布是否合理 

    ​		8）检查碎片整理等

12. **其他**

    ​		网络阻塞、磁盘IO瓶颈、热点等



## 日常巡检报告性能指标解读

- **APM-WEB请求**

  ​		本服务接口被调用响应时间段内请求次数，总响应次数以及响应错误数。

- **APM-外部调用**

  ​		本服务调用外部接口用时时间段内的请求次数，总调用次数已经请求错误数。

- **APM-Redis/DB/MQ**

  ​		本服务调用外部Redis/DB/MQ用时时间段内的请求次数，总调用次数已经请求错误数。

- **Redis集群情况**

  ​		查看应用服务依赖的分布式缓存的集群健康情况。当前连接数，当前使用内存，最大内存等。

- **天网日志**

  ​		查看应用服务所产生的错误日志。是否是可忽略的一些接口超时等错误，及时发现业务逻辑错误和代码异常日志，及时修复。

- **监控大盘**

  ​		查看应用服务平均响应次数，平均响应耗时，响应错误数，以及响应耗时统计。

- **进程监控**

  ​		检查JVM的堆内存、新生代、老年代和CPU的最大使用量以及最大量，机器系统的CPU使用率。



## 压测报告解读

- 平台产品部暑期大促页面性能报告

  ​		1）1m34s的吞吐量为17934.71

  ​		2）平均响应时间31ms，最大响应时间101ms，最小响应时间13ms

  ​		3）90%的请求响应时间<44ms，95%的请求响应时间<50ms，99%的请求响应时间 < 63ms

  ​		4）25台机器100个核心数，CPU使用率21.8%，内存使用率25.67%，进入流量1.95 Mbit/s，出口流量：65.64 Mbit/s

- 平台产品部暑期大促相关接口性能报告

  ​		1）3m3s的吞吐量为4571.24

  ​		2）平均响应时间80ms，最大响应时间979ms，最小响应时间7ms

  ​		3）90%的请求响应时间<196ms，95%的请求响应时间<223ms，99%的请求响应时间<279ms

  ​		4）36台机器72个核心数，CPU使用率3.89%，内存使用率37.23%，进入流量435.95 kbit/s，出口流量：776.10 kbit Mbit/s



## CDN工作原理

#### cdn简介

​		由于用户访问源站业务有性能瓶颈，通过cdn技术把源站的内容缓存到多个节点。用户向源站域名发起请求时，请求会被调度至最接近用户的服务节点，直接由服务节点直接快速响应，有效降低用户访问延迟，提升可用性。

​		了解cdn需要先了解的知识点：**dns解析原理**和**CNAME作用**。

#### dns解析流程

- 首先会查看本地缓存查询是否有对应的域名解析ip
- 没有的情况下，向配置的dns服务器发起请求
- DNS服务器会返回根域名服务器的地址（根域名服务器有多个，所以返回很多域名）
- 本机向根域名发起解析请求，根域名服务器返回.com顶级域名服务器地址
- 本机向com.域名服务器发起请求，返回alston.com.域名服务器地址
- 最后向alston.com域名发起请求得到www.alston.com 的ip地址

#### CNAME作用

​		别名记录。这种记录允许您将多个名字映射到另外一个域名。通常用于同时提供WWW和MAIL服务的计算机。例如，有一台计算机名为host.alston.com（A记录）。它同时提供WWW和MAIL服务，为了便于用户访问服务。可以为该计算机设置两个别名（CNAME）：WWW和MAIL。这两个别名的全称就http://www.alston.com/和mail.alstoncom。实际上他们都指向host.alston.com。

​		在cdn中实现原理是：给源站域名添加CNMAE,别名为加速节点的域名。当用户向源站发起请求时，dns服务器解析源站域名时会发现有CNMAE记录，这时dns服务器会向CNAME域名发起请求，请求会被调度至加速节点的域名。

